== Building

The Stacks CLI can be built locally on a development workstation or in a CI/CD pipeline. It has been configured to use Azure DevOps, but can easily be configured to work with other CI/CD runners, such as GitLab CI and GitHub Actions.

The chapter illustrates how to get a development environment up and running and also how the CI/CD is configured.

=== Local Development

==== Install Go

.Installing Go on different platforms
[options="header"]
|===
| Platform | Package Manager | Command
| Linux | - | `wget https://golang.org/dl/go1.16.6.linux-amd64.tar.gz -O golang.tar.gz \| sudo tar -C /usr/local/ -zxf golang.tar.gz`
| Mac OS | Homebrew | `brew install go`
| Windows | Chocolatey | `choco install golang`
| Windows | Winget | `winget install -e --id GoLang.Go`
|===

==== Clone the `stacks-cli` repository

Clone the repository to a location on disk, for example `C:\users\russell\workspaces\stacks\stacks-cli`.

[source,bash]
----
mkdir -p ~/workspaces/stacks
cd ~/workspaces/stacks
git clone git@github.com:amido/stacks-cli.git
----

==== Build the CLI

The necessary packages will be downloaded and a binary created for the platform that the command is running on. In the examples below this has been run in a PowerShell terminal and in WSL.

It is necessary to set the `GOPATH` environment variable so that the packages are installed into the correct location for app. It is recommended that the `GOPATH` is set to the parent directory of `stacks-cli`. This may cause problems if already using Go, in which case clone `stacks-cli` into the `GOPATH` already configured on the local machine.

===== PowerShell

The `GOPATH` can be set globally or for the current session. It is recommended to set it globally. In this case the `GOPATH` would be set to `C:\users\russell\workspaces\stacks`

[source,powershell]
----
cd ~/workspaces/stacks/stacks-cli
 
# Get all the package dependencies
go get ./...

# Build the application
go build
----

===== Linux (WSL)

The `GOPATH` can be set globally or for the current session. It is recommended to set it globally. In this case the `GOPATH` would be set to `~/workspaces/stacks`

[source,bash]
----
cd ~/workspaces/stacks/stacks-cli
 
# Get all the package dependencies
go get ./...

# Build the application
go build
----

The output of this will be similar to the following.

.Quickstart Output - WSL
image::images/quickstart_output_wsl.png[]

=== Build Pipeline

A build pipeline file exists in `./build` that controls how the CLI is compiled in Azure DevOps.

The build consists of three files:

.Build files
[options="header"]
|===
| Name | Description

| `azuredevops-pipeline.yml` | Main pipeline file that AzDo uses to run the build
| `azuredevops-compile.yml` | Template file that is repeatedly called for each of the target platforms for the CLI
| `azuredevops-vars.yml` | Variable template file containing variables for the build
|===

==== Template Build File

By using the template build file, it is possible to make Azure DevOps create the entire pipeline without it having to be explicitly configured.

For example, the following snippet is from the `azuredevops-pipeline.yml` file:

[source,yaml]
    - template: azuredevops-compile.yml
    parameters:
        platforms: 
        - os: linux
            arch: amd64
            file_extension:
        - os: darwin
            arch: amd64
            file_extension:     
        - os: windows
            arch: amd64
            file_extension: .exe

In this case the template file would be called three times, and on each time it will pass in the platform details. At the end of the build there would be three binaries as a result of the compilation. This makes it very easy to add another platform without having to explicitly write it out.

When the build runs, Azure DevOps will expand out the build into _all_ the steps it creates:

.Build steps
image::images/azdo_build_steps.png[]

All of the compile binaries are copied up to the artefact directory in Azure DevOps.

.Build aretfacts
image::images/azdo_artefacts.png[]