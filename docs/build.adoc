== Building

The Stacks CLI can be built locally on a development workstation or in a CI/CD pipeline. It has been configured to use Azure DevOps, but can easily be configured to work with other CI/CD runners, such as GitLab CI and GitHub Actions.

The chapter illustrates how to get a development environment up and running and also how the CI/CD is configured.

=== Local Development

==== Install Go

.Installing Go on different platforms
[options="header"]
|===
| Platform | Package Manager | Command
| Linux | - | `wget https://golang.org/dl/go1.16.6.linux-amd64.tar.gz -O golang.tar.gz \| sudo tar -C /usr/local/ -zxf golang.tar.gz`
| Mac OS | Homebrew | `brew install go`
| Windows | Chocolatey | `choco install golang`
| Windows | Winget | `winget install -e --id GoLang.Go`
|===

==== Install Taskfile

Taskfile[https://taskfile.dev/#/] is being used as in independent runner to build and test the code as well as generate this documentation. This means that whatever CI/CD runner is being used only needs to bootstrap the environment to run Taskfile.

Regardless of whether the CLI is being built on a local machine or in a build agent Taskfile needs to be installed.

.Installing Taskfile on different platforms
[options="header"]
|===
| Platform | Package Manager | Command
| Linux | - | `sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin`
| Mac OS | Homebrew | `brew install go-task/tap/go-task`
| Windows | Chocolatey | `choco install go-task` 
|===

In the case of the Azure DevOps build file Taskfile is being downloaded directly from the release page of the project. This is so that we can control the version that is downloaded.

==== Clone the `stacks-cli` repository

Clone the repository to a location on disk, for example `C:\users\russell\workspaces\stacks\stacks-cli`.

[source,bash]
----
mkdir -p ~/workspaces/stacks
cd ~/workspaces/stacks
git clone git@github.com:amido/stacks-cli.git
----

==== Build the CLI

Building the Stacks CLI is as simple as running the default tasks using Taskfile. The default task is set to perform the following operations:

. Execute Tests
.. Run tests
.. Generate reports
. Compile
.. Create binaries for Windows, Linux and Mac OS

As this is the default task list, performing all tests and compiling the code is as simple as running one command in the stacks-cli repo directory.

[source,bash]
----
task
----

The output of the command will be similar to the following.

.Test and compile Stacks CLI
image::images/taskfile_compile.png[]


=== Build Pipeline

A build pipeline file exists in `./build` that controls how the CLI is compiled in Azure DevOps.

The build consists of three files:

.Build files
[options="header"]
|===
| Name | Description

| `azuredevops-pipeline.yml` | Main pipeline file that AzDo uses to run the build
| `azuredevops-compile.yml` | Template file that is repeatedly called for each of the target platforms for the CLI
| `azuredevops-vars.yml` | Variable template file containing variables for the build
|===

==== Build Pipeline File

The build pipeline for Azure DevOps, `build/azuredevops-taskfile.yml`, has been configured to bootstrap the environment for Taskfile to run. These steps are as follows:

. Install specified version of Go
. Install Taskfile
. Test and Compile
.. Configure GOPATH and PATH environment variables
.. Run default task of Taskfile
.. Run docs task of Taskfile
. Upload Test results
. Upload Coverage reports
. Upload manual

All of the testing, compilation and documentation has been handled by Taskfile, the parts outside of this are to install Go and Taskfile and to upload build artefacts.

.Build steps
image::images/azdo_build_steps.png[width=300]


All of the compiled binaries, test reports and documentation are copied up to the artefact directory in Azure DevOps.

.Build aretfacts
image::images/azdo_artefacts.png[]