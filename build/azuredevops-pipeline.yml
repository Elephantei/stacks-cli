
# Set the name which will define the build number
name: 0.0$(Rev:.r)

# Set the agent pool that is going to be used for the build
pool:
  vmImage: ubuntu-20.04

variables:
  - template: azuredevops-vars.yml

stages:
  - stage: Build

    jobs:

    - job: Build
      steps:

      # Ensure using correct version of Golang
      - task: GoTool@0
        displayName: Setting GO Version
        inputs:
          version: ${{ variables.GoVersion }}

      # Install the dependencies for the CLI
      - task: Go@0
        displayName: Install Dependencies
        inputs:
          command: get
          arguments: -d

      # Run any Unit tests
      - task: Bash@3
        displayName: Run Unit Tests
        inputs:
          filePath: build/run_tests.sh
          workingDirectory: $(Build.SourcesDirectory)

      # Compile the code for the supported platforms
      - template: azuredevops-compile.yml
        parameters:
          platforms: 
            - os: linux
              arch: amd64
              file_extension:
            - os: darwin
              arch: amd64
              file_extension:     
            - os: windows
              arch: amd64
              file_extension: .exe

      - task: CopyFiles@2
        displayName: Copy binaries
        inputs:
          contents: $(OutputDir)/*
          targetFolder: $(Build.ArtifactStagingDirectory)    
          flattenFolders: true

      - task: PublishBuildArtifacts@1
        displayName: Publish Binaries
        inputs:
          pathToPublish: $(Build.ArtifactStagingDirectory)
          artifactName: StacksCLI                        

    